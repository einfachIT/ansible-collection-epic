---
- name: Install parted command line tool
  apt:
    name: parted

- name: Read device information (always use unit when probing)
  community.general.parted: "device={{ ext_disk_device }} unit=MiB"
  register: dev_info

- name: Remove all partitions from disk
  community.general.parted:
    device: "{{ ext_disk_device }}"
    number: '{{ item.num }}'
    state: absent
  loop: '{{ dev_info.partitions }}'
  register: partitions
  when: ext_disk_whipe
  
- name: Create a new ext4 primary partition
  community.general.parted:
    device: "{{ ext_disk_device }}"
    number: 1
    part_start: 0%
    part_end: 100%
    fs_type: "ext4"
    state: present
  when: partitions.changed

- name: Create a ext4 filesystem on /dev/sdb1 and check disk blocks
  community.general.filesystem:
    fstype: ext4
    dev: "{{ ext_disk_device }}"

- name: "create {{ mountpoint }} mountpoint"
  ansible.builtin.file:
    path: "{{ mountpoint }}"
    state: directory
    mode: '0755'

- name: Mount partition
  ansible.posix.mount:
    path: "{{ ext_disk_mountpoint }}" 
    src: "{{ ext_disk_device }}"
    fstype: ext4
    state: mounted
